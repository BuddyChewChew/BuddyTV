<script>
    let channels = [];

    function fetchM3U() {
        fetch('https://raw.githubusercontent.com/BuddyChewChew/My-Streams/refs/heads/main/buddy_stream_player.m3u', {
            headers: {
                'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36'
            }
        })
        .then(response => response.text())
        .then(data => parseM3U(data))
        .catch(error => console.error('Error:', error));
    }

    function parseM3U(data) {
        const lines = data.split('\n');
        let currentChannel = {};

        for (let line of lines) {
            if (line.startsWith('#EXTINF:')) {
                const titleMatch = line.match(/,(.+)/);
                currentChannel.title = titleMatch ? titleMatch[1].trim() : 'Untitled Channel';
            } else if (line.trim() !== '' && !line.startsWith('#')) {
                currentChannel.url = line.trim();
                channels.push(currentChannel);
                currentChannel = {};
            }
        }

        displayChannels();
    }

    function displayChannels() {
        const channelList = document.getElementById('channelList');
        channelList.innerHTML = '';

        channels.forEach((channel, index) => {
            const channelItem = document.createElement('div');
            channelItem.className = 'channel-item';
            channelItem.textContent = channel.title;
            channelItem.onclick = () => playChannel(index);
            channelList.appendChild(channelItem);
        });
    }

    function playChannel(index) {
        const channel = channels[index];
        const videoPlayer = document.getElementById('videoPlayer');
        const videoTitle = document.getElementById('videoTitle');

        videoTitle.textContent = channel.title;

        if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(channel.url);
            hls.attachMedia(videoPlayer);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                videoPlayer.play();
            });
        }
        // For native HLS support (Safari)
        else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
            videoPlayer.src = channel.url;
            videoPlayer.addEventListener('loadedmetadata', function() {
                videoPlayer.play();
            });
        }
        else {
            console.error('This browser does not support HLS playback');
        }
    }

    fetchM3U();
</script>
